"""{{ module_name }} component â€” pre-converted schema and codec."""

from __future__ import annotations

import functools
import json
from importlib.resources import files as importlib_files
from typing import TYPE_CHECKING, Any

if TYPE_CHECKING:
    from json_schema_llm_engine import (
        LlmRoundtripEngine,
        LlmTransport,
        ProviderConfig,
        ProviderFormatter,
        RoundtripResult,
    )


@functools.lru_cache(maxsize=1)
def schema() -> Any:
    """Load the LLM-compatible schema for {{ component_name }}."""
    return _load_resource("schemas/{{ schema_path }}")


@functools.lru_cache(maxsize=1)
def codec() -> Any:
    """Load the codec (rehydration map) for {{ component_name }}."""
    return _load_resource("schemas/{{ codec_path }}")


@functools.lru_cache(maxsize=1)
def original() -> Any:
    """Load the original (pre-conversion) sub-schema for {{ component_name }}."""
    return _load_resource("schemas/{{ original_path }}")


def generate(
    prompt: str,
    engine: LlmRoundtripEngine,
    formatter: ProviderFormatter,
    config: ProviderConfig,
    transport: LlmTransport,
) -> RoundtripResult:
    """Run a full LLM roundtrip for {{ component_name }} using pre-built artifacts.

    Convenience wrapper that wires the pre-built :func:`original`, :func:`codec`,
    and :func:`schema` into :meth:`~json_schema_llm_engine.LlmRoundtripEngine.generate_with_preconverted`
    so callers don't need to manage the three-way split themselves.

    Args:
        prompt: The natural language prompt for the LLM.
        engine: An initialized :class:`~json_schema_llm_engine.LlmRoundtripEngine`.
        formatter: Provider-specific request formatter.
        config: Provider endpoint/model configuration.
        transport: Consumer-provided HTTP transport.

    Returns:
        :class:`~json_schema_llm_engine.RoundtripResult` with rehydrated data and validation info.
    """
    return engine.generate_with_preconverted(
        schema_json=json.dumps(original()),
        codec_json=json.dumps(codec()),
        llm_schema=schema(),
        prompt=prompt,
        formatter=formatter,
        config=config,
        transport=transport,
    )


def _load_resource(path: str) -> Any:
    ref = importlib_files("{{ package_name }}").joinpath(path)
    return json.loads(ref.read_text(encoding="utf-8"))
