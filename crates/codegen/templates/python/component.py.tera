"""{{ module_name }} component â€” pre-converted schema and codec."""

from __future__ import annotations

import functools
import json
from importlib.resources import files as importlib_files
from typing import TYPE_CHECKING, List

from {{ package_name }}.json_patch import JsonPatchOp

if TYPE_CHECKING:
    from json_schema_llm_engine import (
        LlmRoundtripEngine,
        RoundtripResult,
    )


# -----------------------------------------------------------------------
# Schema accessors
# -----------------------------------------------------------------------


@functools.lru_cache(maxsize=1)
def schema():
    """Load the LLM-compatible schema for {{ component_name }}."""
    return _load_resource("schemas/{{ schema_path }}")


@functools.lru_cache(maxsize=1)
def codec():
    """Load the codec (rehydration map) for {{ component_name }}."""
    return _load_resource("schemas/{{ codec_path }}")


@functools.lru_cache(maxsize=1)
def original():
    """Load the original (pre-conversion) sub-schema for {{ component_name }}."""
    return _load_resource("schemas/{{ original_path }}")


# -----------------------------------------------------------------------
# Generate methods
# -----------------------------------------------------------------------


def generate(prompt: str, engine: LlmRoundtripEngine) -> RoundtripResult:
    """Run a full LLM roundtrip for {{ component_name }} using pre-built artifacts.

    Args:
        prompt: The natural language prompt for the LLM.
        engine: An initialized LlmRoundtripEngine.

    Returns:
        RoundtripResult with rehydrated data and validation info.
    """
    return engine.generate_with_preconverted(
        schema_json=json.dumps(original()),
        codec_json=json.dumps(codec()),
        llm_schema=schema(),
        prompt=prompt,
    )


def generate_with_patch(
    prompt: str,
    engine: LlmRoundtripEngine,
    ops: List[JsonPatchOp],
) -> RoundtripResult:
    """Run a full LLM roundtrip with RFC 6902 JSON Patch applied before conversion.

    Args:
        prompt: The natural language prompt for the LLM.
        engine: An initialized LlmRoundtripEngine.
        ops: RFC 6902 JSON Patch operations to apply to the source schema.

    Returns:
        RoundtripResult with rehydrated data and validation info.
    """
    patch_json = json.dumps([op.to_dict() for op in ops])
    return engine.generate_with_patch(json.dumps(original()), prompt, patch_json)


# -----------------------------------------------------------------------
# Internal
# -----------------------------------------------------------------------


def _load_resource(path: str):
    ref = importlib_files("{{ package_name }}").joinpath(path)
    return json.loads(ref.read_text(encoding="utf-8"))
