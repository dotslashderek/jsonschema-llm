# frozen_string_literal: true

# Auto-generated by json-schema-llm â€” do not edit.
# Component: {{ component_name }}

require "json"
require_relative "json_patch"

module {{ generator_module }}
  module {{ module_name }}
    SCHEMA_PATH = File.join(__dir__, "schemas", "{{ schema_path }}")
    CODEC_PATH  = File.join(__dir__, "schemas", "{{ codec_path }}")
    ORIGINAL_PATH = File.join(__dir__, "schemas", "{{ original_path }}")

    # -------------------------------------------------------------------
    # Schema accessors
    # -------------------------------------------------------------------

    # Load the LLM-compatible schema for {{ component_name }}.
    # @return [Hash] the parsed JSON schema
    def self.schema
      @schema ||= JSON.parse(File.read(SCHEMA_PATH))
    end

    # Load the rehydration codec for {{ component_name }}.
    # @return [Hash] the parsed codec
    def self.codec
      @codec ||= JSON.parse(File.read(CODEC_PATH))
    end

    # Load the original JSON Schema for {{ component_name }}.
    # @return [Hash] the parsed original schema
    def self.original
      @original ||= JSON.parse(File.read(ORIGINAL_PATH))
    end

    # -------------------------------------------------------------------
    # Generate methods
    # -------------------------------------------------------------------

    # Run a full LLM roundtrip for {{ component_name }} using pre-built artifacts.
    #
    # @param prompt [String] the natural language prompt
    # @param engine [JsonSchemaLlmEngine::LlmRoundtripEngine] the roundtrip engine
    # @return [JsonSchemaLlmEngine::RoundtripResult]
    def self.generate(prompt, engine)
      engine.generate_with_preconverted(
        original_schema_json: JSON.generate(original),
        codec_json: JSON.generate(codec),
        llm_schema: schema,
        prompt: prompt
      )
    end

    # Run a full LLM roundtrip with RFC 6902 JSON Patch applied before conversion.
    #
    # @param prompt [String] the natural language prompt
    # @param engine [JsonSchemaLlmEngine::LlmRoundtripEngine] the roundtrip engine
    # @param ops [Array<JsonPatchOp::Add, JsonPatchOp::Remove, ...>] patch operations
    # @return [JsonSchemaLlmEngine::RoundtripResult]
    def self.generate_with_patch(prompt, engine, ops:)
      patch_json = JSON.generate(ops.map(&:to_h))
      engine.generate_with_patch(
        schema_json: JSON.generate(original),
        prompt: prompt,
        patch_json: patch_json
      )
    end
  end
end
