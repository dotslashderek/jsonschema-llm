name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same workflow + branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  check:
    name: Check (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2

      - name: Check formatting (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: cargo fmt --all -- --check

      - name: Clippy lints
        run: cargo clippy --workspace --exclude jsonschema-llm-python --all-targets -- -D warnings

      - name: Run tests
        run: |
          echo "::group::Unit & Integration Tests"
          cargo test --workspace --exclude jsonschema-llm-python --all-targets
          echo "::endgroup::"

          echo "::group::Doc Tests"
          cargo test --workspace --exclude jsonschema-llm-python --doc
          echo "::endgroup::"

      - name: Build release binary
        run: cargo build --release

      - name: Verify benchmarks compile (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: cargo bench --workspace --no-run

  wasm:
    name: WASM Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: v0.13.1

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.10.0

      - name: Verify core compiles for wasm32
        run: cargo check -p jsonschema-llm-core --target wasm32-unknown-unknown

      - name: Run WASM smoke tests
        run: wasm-pack test --node crates/jsonschema-llm-wasm

      - name: Build WASM (nodejs)
        run: wasm-pack build crates/jsonschema-llm-wasm --target nodejs --out-dir ../../tests/contract-node/pkg

      - name: Build WASM (web)
        run: wasm-pack build crates/jsonschema-llm-wasm --target web

      - name: Install contract test dependencies
        run: pnpm install --frozen-lockfile
        working-directory: tests/contract-node

      - name: Run Node.js contract tests
        run: pnpm test
        working-directory: tests/contract-node

      - name: TypeScript type-check
        run: pnpm run typecheck
        working-directory: tests/contract-node

      # --- npm package assembly validation (#90) ---
      - name: Build WASM (nodejs) for npm assembly
        run: wasm-pack build crates/jsonschema-llm-wasm --target nodejs --out-dir pkg-nodejs

      - name: Build WASM (web) for npm assembly
        run: wasm-pack build crates/jsonschema-llm-wasm --target web --out-dir pkg-web

      - name: Assemble npm package
        run: bash scripts/assemble-npm.sh

      - name: Validate npm package
        run: |
          echo "::group::Validate package.json fields"
          jq -e '.name == "jsonschema-llm"' dist/package.json
          jq -e '.exports["."].types == "./jsonschema_llm_wasm.d.ts"' dist/package.json
          jq -e '.exports["."].node == "./jsonschema_llm_wasm.js"' dist/package.json
          jq -e '.exports["."].default == "./web/jsonschema_llm_wasm.js"' dist/package.json
          jq -e '.exports["./web"].types == "./web/jsonschema_llm_wasm.d.ts"' dist/package.json
          jq -e '.exports["./web"].default == "./web/jsonschema_llm_wasm.js"' dist/package.json
          echo "::endgroup::"

          echo "::group::Validate critical files exist"
          test -f dist/jsonschema_llm_wasm_bg.wasm
          test -f dist/jsonschema_llm_wasm.js
          test -f dist/jsonschema_llm_wasm.d.ts
          test -f dist/web/jsonschema_llm_wasm_bg.wasm
          test -f dist/web/jsonschema_llm_wasm.js
          test -f dist/web/jsonschema_llm_wasm.d.ts
          echo "::endgroup::"

          echo "âœ… npm package validation passed"

  python:
    name: Python Bindings
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2

      - name: Install maturin
        run: python -m pip install maturin

      - name: Clippy (Python crate)
        run: cargo clippy -p jsonschema-llm-python -- -D warnings

      - name: Create virtualenv
        run: python -m venv .venv
        working-directory: crates/jsonschema-llm-python

      - name: Build and install via maturin
        run: |
          source .venv/bin/activate
          pip install pytest
          maturin develop
        working-directory: crates/jsonschema-llm-python

      - name: Verify import
        run: |
          source crates/jsonschema-llm-python/.venv/bin/activate
          python -c "import jsonschema_llm; print('import OK')"

      - name: Run acceptance tests
        run: |
          source .venv/bin/activate
          python -m pytest tests/ -v
        working-directory: crates/jsonschema-llm-python
