name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same workflow + branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  check:
    name: Check (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2

      - name: Check formatting (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: cargo fmt --all -- --check

      - name: Clippy lints
        run: cargo clippy --workspace --exclude json-schema-llm-wasi --all-targets -- -D warnings

      - name: Run tests
        run: |
          echo "::group::Unit & Integration Tests"
          cargo test --workspace --exclude json-schema-llm-wasi --all-targets
          echo "::endgroup::"

          echo "::group::Doc Tests"
          cargo test --workspace --exclude json-schema-llm-wasi --doc
          echo "::endgroup::"

      - name: Build release binary
        run: cargo build --release

      - name: Fixture snapshot regression check (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          ./scripts/generate-fixtures.sh
          git diff --exit-code fixtures/
          test -z "$(git status --porcelain fixtures/)" || { echo '::error::Untracked fixture files detected'; git status --porcelain fixtures/; exit 1; }

      - name: Verify benchmarks compile (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: cargo bench --workspace --no-run

  wasm:
    name: WASM Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: v0.13.1

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.10.0

      - name: Verify core compiles for wasm32
        run: cargo check -p json-schema-llm-core --target wasm32-unknown-unknown

      - name: Run WASM smoke tests
        run: wasm-pack test --node crates/json-schema-llm-wasm

      - name: Build WASM (nodejs)
        run: wasm-pack build crates/json-schema-llm-wasm --target nodejs --out-dir ../../tests/contract-node/pkg

      - name: Build WASM (web)
        run: wasm-pack build crates/json-schema-llm-wasm --target web

      - name: Install contract test dependencies
        run: pnpm install --frozen-lockfile --ignore-workspace
        working-directory: tests/contract-node

      - name: Run Node.js contract tests
        run: pnpm test
        working-directory: tests/contract-node

      - name: TypeScript type-check
        run: pnpm run typecheck
        working-directory: tests/contract-node

      # --- npm package assembly validation (#90) ---
      - name: Build WASM (nodejs) for npm assembly
        run: wasm-pack build crates/json-schema-llm-wasm --target nodejs --out-dir pkg-nodejs

      - name: Build WASM (web) for npm assembly
        run: wasm-pack build crates/json-schema-llm-wasm --target web --out-dir pkg-web

      - name: Assemble npm package
        run: bash scripts/assemble-npm.sh

      - name: Validate npm package
        run: |
          echo "::group::Validate package.json fields"
          jq -e '.name == "json-schema-llm"' dist/package.json
          jq -e '.exports["."].types == "./json_schema_llm_wasm.d.ts"' dist/package.json
          jq -e '.exports["."].node == "./json_schema_llm_wasm.js"' dist/package.json
          jq -e '.exports["."].default == "./web/json_schema_llm_wasm.js"' dist/package.json
          jq -e '.exports["./web"].types == "./web/json_schema_llm_wasm.d.ts"' dist/package.json
          jq -e '.exports["./web"].default == "./web/json_schema_llm_wasm.js"' dist/package.json
          echo "::endgroup::"

          echo "::group::Validate critical files exist"
          test -f dist/json_schema_llm_wasm_bg.wasm
          test -f dist/json_schema_llm_wasm.js
          test -f dist/json_schema_llm_wasm.d.ts
          test -f dist/web/json_schema_llm_wasm_bg.wasm
          test -f dist/web/json_schema_llm_wasm.js
          test -f dist/web/json_schema_llm_wasm.d.ts
          echo "::endgroup::"

          echo "✅ npm package validation passed"

  wasi:
    name: WASI Universal Binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2

      - name: Build WASI binary
        run: cargo build --target wasm32-wasip1 --release -p json-schema-llm-wasi

      - name: Check binary size (must be ≤3 MB)
        run: |
          SIZE=$(stat --format=%s target/wasm32-wasip1/release/json_schema_llm_wasi.wasm)
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          echo "Binary size: ${SIZE_MB} MB"
          if [ "$SIZE" -gt 3145728 ]; then
            echo "❌ Binary exceeds 3 MB gate"
            exit 1
          fi
          echo "✅ Binary size within gate"

      - name: Clippy (WASI target)
        run: cargo clippy -p json-schema-llm-wasi --target wasm32-wasip1 -- -D warnings

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install wasmtime Python package
        run: pip install wasmtime

      - name: Run WASI host verification
        run: python3 tests/wasi/host_verify.py

      - name: Upload WASI binary
        uses: actions/upload-artifact@v4
        with:
          name: wasi-binary
          path: target/wasm32-wasip1/release/json_schema_llm_wasi.wasm
          retention-days: 1

  wasi-wrappers:
    name: WASI Wrappers (${{ matrix.lang }})
    runs-on: ubuntu-latest
    needs: wasi
    strategy:
      matrix:
        lang: [go, python, ts, java, ruby, dotnet]
    steps:
      - uses: actions/checkout@v4

      - name: Download WASI binary
        uses: actions/download-artifact@v4
        with:
          name: wasi-binary
          path: target/wasm32-wasip1/release

      - name: Setup Go
        if: matrix.lang == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Copy WASM for Go embed
        if: matrix.lang == 'go'
        run: cp target/wasm32-wasip1/release/json_schema_llm_wasi.wasm bindings/go/wasm/

      - name: Run Go wrapper tests
        if: matrix.lang == 'go'
        run: go test -v ./...
        working-directory: bindings/go

      - name: Setup Python
        if: matrix.lang == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        if: matrix.lang == 'python'
        run: pip install -r requirements.txt
        working-directory: bindings/python

      - name: Run Python WASI tests
        if: matrix.lang == 'python'
        run: python -m pytest -v test_wasi.py
        working-directory: bindings/python

      - name: Setup Node
        if: matrix.lang == 'ts'
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        if: matrix.lang == 'ts'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install TS deps
        if: matrix.lang == 'ts'
        run: pnpm install --no-frozen-lockfile
        working-directory: bindings/ts

      - name: Build and test TS wrapper
        if: matrix.lang == 'ts'
        run: pnpm run build && pnpm run test
        working-directory: bindings/ts

      - name: Setup Java
        if: matrix.lang == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Run Java wrapper tests
        if: matrix.lang == 'java'
        run: ./gradlew test
        working-directory: bindings/java

      - name: Setup Ruby
        if: matrix.lang == 'ruby'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
          working-directory: bindings/ruby

      - name: Run Ruby wrapper tests
        if: matrix.lang == 'ruby'
        run: bundle exec rake test
        working-directory: bindings/ruby
        env:
          JSL_WASM_PATH: ${{ github.workspace }}/target/wasm32-wasip1/release/json_schema_llm_wasi.wasm

      - name: Setup .NET
        if: matrix.lang == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0"

      - name: Run .NET wrapper tests
        if: matrix.lang == 'dotnet'
        run: dotnet test test/JsonSchemaLlmTests.csproj -v normal
        working-directory: bindings/dotnet
        env:
          JSL_WASM_PATH: ${{ github.workspace }}/target/wasm32-wasip1/release/json_schema_llm_wasi.wasm

  engine-tests:
    name: Engine Tests (${{ matrix.engine }})
    runs-on: ubuntu-latest
    needs: wasi
    strategy:
      matrix:
        engine: [python, java, ruby]
    steps:
      - uses: actions/checkout@v4

      - name: Download WASI binary
        uses: actions/download-artifact@v4
        with:
          name: wasi-binary
          path: target/wasm32-wasip1/release

      # ── Python engine ────────────────────────────────────────────
      - name: Setup Python
        if: matrix.engine == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Distribute WASM to Engine Python bundle
        if: matrix.engine == 'python'
        run: |
          mkdir -p engine/python/json_schema_llm_engine/wasm
          cp target/wasm32-wasip1/release/json_schema_llm_wasi.wasm \
            engine/python/json_schema_llm_engine/wasm/json_schema_llm_wasi.wasm

      - name: Install Python engine deps
        if: matrix.engine == 'python'
        run: pip install -e ".[dev]"
        working-directory: engine/python

      - name: Run Python engine tests
        if: matrix.engine == 'python'
        run: python -m pytest -v
        working-directory: engine/python

      # ── Java engine ──────────────────────────────────────────────
      - name: Setup Java
        if: matrix.engine == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Build Java WASI bindings (local Maven)
        if: matrix.engine == 'java'
        run: ./gradlew publishToMavenLocal -x test
        working-directory: bindings/java

      - name: Run Java engine tests
        if: matrix.engine == 'java'
        run: mvn test
        working-directory: engine/java

      # ── Ruby engine ──────────────────────────────────────────────
      - name: Setup Ruby
        if: matrix.engine == 'ruby'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
          working-directory: engine/ruby

      - name: Distribute WASM to Engine Ruby
        if: matrix.engine == 'ruby'
        run: echo "WASM available at target path for runtime resolution"

      - name: Run Ruby engine tests
        if: matrix.engine == 'ruby'
        run: bundle exec rake test
        working-directory: engine/ruby
        env:
          JSON_SCHEMA_LLM_WASM_PATH: ${{ github.workspace }}/target/wasm32-wasip1/release/json_schema_llm_wasi.wasm
